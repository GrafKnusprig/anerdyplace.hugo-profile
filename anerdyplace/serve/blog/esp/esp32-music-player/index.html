<!DOCTYPE html>
<html>

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta http-equiv="Accept-CH" content="DPR, Viewport-Width, Width">
<link rel="icon" href=/icon.png type="image/gif">

<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="https://philippraven.com/blog/index.xml">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
>
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      media="print" onload="this.media='all'" />
<noscript>
  <link
          href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
          rel="stylesheet">
</noscript>


<link rel="stylesheet" href="/css/font.css" media="all">



<meta property="og:url" content="https://philippraven.com/blog/esp/esp32-music-player/">
  <meta property="og:site_name" content="philippraven">
  <meta property="og:title" content="ESP32 music player">
  <meta property="og:description" content="ESPod - Shuffle instant music - free of distractions
no boot time, no menus, no bullshit!
❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️
the front side with cute ghosts
and the back side with a little, cute turtle
Yes it’s true I built an ESP32 based music player that can play mp3, wav and flac!
Well, flac is more a proof of concept, including stutters and lags. But the rest works exceptionally well!">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2025-05-26T20:47:00+02:00">
    <meta property="article:modified_time" content="2025-05-26T20:47:00+02:00">
    <meta property="article:tag" content="Music">
    <meta property="article:tag" content="Mp3">
    <meta property="article:tag" content="Flac">
    <meta property="article:tag" content="Wav">
    <meta property="article:tag" content="Player">
    <meta property="article:tag" content="Esp32">

<!-- ENTERING ogimage.html (open graph) --><meta property="og:image" content="https://philippraven.com//blog/esp/esp32-music-player/3D-model.webp" />

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ESP32 music player">
  <meta name="twitter:description" content="ESPod - Shuffle instant music - free of distractions
no boot time, no menus, no bullshit!
❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️
the front side with cute ghosts
and the back side with a little, cute turtle
Yes it’s true I built an ESP32 based music player that can play mp3, wav and flac!
Well, flac is more a proof of concept, including stutters and lags. But the rest works exceptionally well!">


<link rel="stylesheet" href="/bootstrap-5/css/bootstrap.min.css" media="all"><link rel="stylesheet" href="/css/header.css" media="all">
<link rel="stylesheet" href="/css/footer.css" media="all">


<link rel="stylesheet" href="/css/theme.css" media="all">




<style>
    :root {
        --text-color: #343a40;
        --text-secondary-color: #6c757d;
        --background-color: #eaedf0;
        --secondary-background-color: #64ffda;
        --primary-color: #7c0082;
        --secondary-color: #f8f9fa;

         
        --text-color-dark: #e4e6eb;
        --text-secondary-color-dark: #b0b3b8;
        --background-color-dark: #18191a;
        --secondary-background-color-dark: #212529;
        --primary-color-dark: #ffffff;
        --secondary-color-dark: #212529;
    }
    
    body {
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        text-align: left;
    }

    html {
        background-color: var(--background-color) !important;
    }

    body::-webkit-scrollbar {
        width: .5em;
        height: .5em;
        background-color: var(--background-color);
    }
    
    ::-webkit-scrollbar-track {
        box-shadow: inset 0 0 6px var(--background-color);
        border-radius: 1rem;
    }
    
    ::-webkit-scrollbar-thumb {
        border-radius: 1rem;
        background-color: var(--secondary-color);
        outline: 1px solid var(--background-color);
    }

    #search-content::-webkit-scrollbar {
        width: .5em;
        height: .1em;
        background-color: var(--background-color);
    }
</style>

<meta name="description" content="">
<link rel="stylesheet" href="/css/single.css">


<script defer src="/fontawesome-5/all-5.15.4.js"></script>

  <title>
ESP32 music player | philippraven

  </title>
</head>

<body class="light">
  
  
<script>
    let localStorageValue = localStorage.getItem("pref-theme");
    let mediaQuery = window.matchMedia('(prefers-color-scheme: dark)').matches;

    switch (localStorageValue) {
        case "dark":
            document.body.classList.add('dark');
            break;
        case "light":
            document.body.classList.remove('dark');
            break;
        default:
            if (mediaQuery) {
                document.body.classList.add('dark');
            }
            break;
    }
</script>



<header>
    <nav class="pt-3 navbar navbar-expand-lg ">
        <div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5">
            
            <a class="navbar-brand primary-font text-wrap" href="/">
                
                <img src="/icon.png" width="30" height="30"
                    class="d-inline-block align-top">
                philippraven
                
            </a>

            

            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
                aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <svg aria-hidden="true" height="24" viewBox="0 0 16 16" version="1.1" width="24" data-view-component="true">
                    <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z"></path>
                </svg>
            </button>

            
            <div class="collapse navbar-collapse text-wrap primary-font" id="navbarContent">
                <ul class="navbar-nav ms-auto text-center">
                    

                    
                    
                    
                    
                    <li class="nav-item navbar-text dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="About">
                            About
                        </a>
                        <div class="dropdown-menu shadow-lg rounded" aria-labelledby="navbarDropdown">
                            
                            <a class="dropdown-item text-center nav-link" href="/"
                                title="Home">
                                Home
                            </a>
                            
                            <a class="dropdown-item text-center nav-link" href="/#about"
                                title="About me">
                                About me
                            </a>
                            
                            <a class="dropdown-item text-center nav-link" href="/#experience"
                                title="Experience">
                                Experience
                            </a>
                            
                            <a class="dropdown-item text-center nav-link" href="/#education"
                                title="Education">
                                Education
                            </a>
                            
                            <a class="dropdown-item text-center nav-link" href="/#projects"
                                title="Projects">
                                Projects
                            </a>
                            
                            <a class="dropdown-item text-center nav-link" href="/#contact"
                                title="Contact me">
                                Contact me
                            </a>
                            
                        </div>
                    </li>
                    
                    
                    
                    
                    <li class="nav-item navbar-text">
                        <a class="nav-link" href="/blog" title="Blog posts">
                            
                            Blog
                        </a>
                    </li>
                    
                    
                    
                    
                    <li class="nav-item navbar-text">
                        <a class="nav-link" href="/gallery" title="Gallery">
                            
                            Gallery
                        </a>
                    </li>
                    
                    
                    
                    
                    <li class="nav-item navbar-text">
                        <a class="nav-link" href="/search" title="Search">
                            
                            Search
                        </a>
                    </li>
                    
                    

                    
                    <li class="nav-item navbar-text">
                        
                        <div class="text-center">
                            <button id="theme-toggle">
                                <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                </svg>
                                <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="5"></circle>
                                    <line x1="12" y1="1" x2="12" y2="3"></line>
                                    <line x1="12" y1="21" x2="12" y2="23"></line>
                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                    <line x1="1" y1="12" x2="3" y2="12"></line>
                                    <line x1="21" y1="12" x2="23" y2="12"></line>
                                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                </svg>
                            </button>
                        </div>
                    </li>
                    

                </ul>

            </div>
        </div>
    </nav>
</header>
<div id="content">
<section id="single">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-sm-12 col-md-12 col-lg-9">
        <div class="pr-lg-4">
          <div class="title mb-5">
            <h1 class="text-center mb-4">ESP32 music player</h1>
            <div class="text-center">
              philippraven 
              
			  
			  <small>|</small>
			  
			  
			  
              May 26, 2025
			  
            </div>
          </div>
          
          <article class="page-content  p-2" id="page-content">
          <h1 id="espod---shuffle">ESPod - Shuffle</h1>
<p>instant music - free of distractions</p>
<p>no boot time, no menus, no bullshit!</p>
<p>❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️❤️</p>
<p><p class="md__image">
  <img class="img-fluid" src="player1.webp" alt="front of the player"  />
</p></p>
<blockquote>
<p>the front side with cute ghosts</p></blockquote>
<p><p class="md__image">
  <img class="img-fluid" src="player2.webp" alt="back of the player"  />
</p></p>
<blockquote>
<p>and the back side with a little, cute turtle</p></blockquote>
<hr>
<h1 id="yes-its-true">Yes it&rsquo;s true</h1>
<p>I built an ESP32 based music player that can play mp3, wav and flac!</p>
<p>Well, flac is more a proof of concept, including stutters and lags. But the rest works exceptionally well!</p>
<p>I was totally surprised by the music quality this &rsquo;little&rsquo; thing can deliver.</p>
<h2 id="what-was-my-goal">What was my goal?</h2>
<p>I wanted a super simple, high quality, beefy music player that could take a punch and had a good feel to it.</p>
<p>It also should act like an oldschool cassette walkman! Press play and the music starts where you left of last time - stop and throw it in the bag.</p>
<p>So buttons with a good haptic feel were crucial.</p>
<p>I think I achieved my goal. A big and snappy button starts the player and music is playing in an instant. A bookmark is saved every second, so when you turn the player off and then on again, it continues exactly where you stopped listening.</p>
<h1 id="the-parts">The parts</h1>
<p>For this project I used:</p>
<ul>
<li>ESP32 WROOM Dev Board</li>
<li>PCM5102 Modul DAC I2S</li>
<li>Generic SD card module</li>
<li>134N3P 5V step-up power module</li>
<li>18650 battery</li>
<li>2 buttons</li>
<li>1 beefy on/off switch</li>
</ul>
<p><p class="md__image">
  <img class="img-fluid" src="PCM5102.webp" alt="PCM5102 DAC Module"  />
</p></p>
<blockquote>
<p>the heart: the PCM5102</p></blockquote>
<h2 id="why">Why?</h2>
<p>I recently did a project at work with ESP32s and I kind of fell in love with them, so I ordered a bunch without knowing what to do with them - then came this project. :)</p>
<p>The PCM5102 I did order for another project. I built a few Icecast receivers for a silent disco, but then switched to snapcast. As this was too much to handle for an ESP, I used Raspberries with USB audio-interfaces for this project and was left with this nice DACs. The audio quality is amazing! I really did not expect that depth and clearity from that little module.</p>
<p>The SD module is self explanatory. It&rsquo;s used to read the music from an SD card.</p>
<p>The 18650s I savaged from old notebook batteries. I really love upcycling stuff. &lt;3</p>
<p>For powering the whole thing and for charging the battery, I use the very simple 134N3P. It&rsquo;s designed with 18650 batteries in mind and gets the job done quite well.</p>
<h1 id="the-code">The code</h1>
<p>Oh boy the code&hellip; it was a nightmare.</p>
<p>As always, you can find the complete code of this project on my github: <a href="https://github.com/GrafKnusprig/esp32mp3">esp32mp3</a></p>
<p>Feel free to do what ever you want with this :D</p>
<p>I used the ESP8266Audio library and got the first results pretty fast. After only 5 minutes with ChatGPT (more about this later) I had the first audio files playing on my headphones and I was stunned! The resolution of the sound was extraordinary! I later found out, that the PCM5102 is one of the higher end modules for audio and loved by the community.</p>
<p>That was where the journey began&hellip;</p>
<h2 id="a-week-of-agony">A week of agony</h2>
<p>So listen up. This section is important and can prevent you from running into the same problems!</p>
<p>After the first baby steps I continued to build a full on audio workhorse with the help of ChatGPT - better use that pro subscription!
I very soon ran into strange and non-deterministic problems. Sometimes everything worked and some other times the esp crashed with an Guru Meditation error or access violation completely out of nowhere.</p>
<p>The code that ChatGPT provided was simple and I thought that there&rsquo;s nothing wrong with it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// if a track is running -&gt; close it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (mp3.isRunning())
</span></span><span style="display:flex;"><span>    mp3.stop();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (wav.isRunning())
</span></span><span style="display:flex;"><span>    wav.stop();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (flac.isRunning())
</span></span><span style="display:flex;"><span>    flac.stop();
</span></span><span style="display:flex;"><span>fileSrc.close();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// then start the new track
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> (path.endsWith(<span style="color:#e6db74">&#34;.mp3&#34;</span>) <span style="color:#f92672">||</span> path.endsWith(<span style="color:#e6db74">&#34;.MP3&#34;</span>))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    currentType <span style="color:#f92672">=</span> TYPE_MP3;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (off)
</span></span><span style="display:flex;"><span>        fileSrc.seek(off, SEEK_SET);
</span></span><span style="display:flex;"><span>    mp3.begin(<span style="color:#f92672">&amp;</span>fileSrc, <span style="color:#f92672">&amp;</span>audioOut);
</span></span><span style="display:flex;"><span>    isPlaying <span style="color:#f92672">=</span> mp3.isRunning();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//... same for the other file types
</span></span></span></code></pre></div><h2 id="the-functions">The functions</h2>
<p>A quick overview over the functionality of the player. We need that to go on.</p>
<ul>
<li>
<p>volume up -   press the up botton once</p>
</li>
<li>
<p>volume down - press the down button once</p>
</li>
<li>
<p>next track -  hold the up button</p>
</li>
<li>
<p>previous track -  hold the down button</p>
</li>
<li>
<p>in the first attempt there were 2 modes:</p>
<ul>
<li>shuffle all
<ul>
<li>shuffles all songs on the sd card</li>
</ul>
</li>
<li>shuffle folder
<ul>
<li>shuffles only the songs of the current folder</li>
</ul>
</li>
<li>the 2 modes can be switched by pressing and holding both buttons</li>
<li>you can skip to the next folder by shortly pressing both buttons</li>
</ul>
</li>
</ul>
<h2 id="back-to-the-agony">Back to the agony</h2>
<p>&hellip; Sometimes the ESP didn&rsquo;t crash for 10 songs, then it crashed every time you skipped to the next song.</p>
<p>Hours and hours I spent together with ChatGPT trying to solve the problem. I added locks, memory-saving methods, checked the heap, and used mutexes to regulate read and write access to the SD card. All without success.</p>
<p>Then it dawned on me. It wasn&rsquo;t that I had forgotten how to code—the problem was ChatGPT itself. It kept going in circles, making the code more and more complex and convoluted, and nothing made sense anymore. The errors piled up and nothing worked as it should. At that point, I was ready to give up on the project entirely. But then I decided to start over from scratch and tackle the problem myself.</p>
<p>The only thing I kept from ChatGPT&rsquo;s logic was accessing the SD card using a mutex. That actually made sense. Everything else I solved the conventional way: I read documentation and looked at examples. It turned out that you have to handle the library a bit differently:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// Stop any running decoder and cleanup
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (mp3 <span style="color:#f92672">&amp;&amp;</span> mp3<span style="color:#f92672">-&gt;</span>isRunning())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        mp3<span style="color:#f92672">-&gt;</span>stop();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">delete</span> mp3;
</span></span><span style="display:flex;"><span>        mp3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (wav <span style="color:#f92672">&amp;&amp;</span> wav<span style="color:#f92672">-&gt;</span>isRunning())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        wav<span style="color:#f92672">-&gt;</span>stop();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">delete</span> wav;
</span></span><span style="display:flex;"><span>        wav <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (flac <span style="color:#f92672">&amp;&amp;</span> flac<span style="color:#f92672">-&gt;</span>isRunning())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        flac<span style="color:#f92672">-&gt;</span>stop();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">delete</span> flac;
</span></span><span style="display:flex;"><span>        flac <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (fileSrc)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        fileSrc<span style="color:#f92672">-&gt;</span>close();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">delete</span> fileSrc;
</span></span><span style="display:flex;"><span>        fileSrc <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (currentPath.endsWith(<span style="color:#e6db74">&#34;.mp3&#34;</span>) <span style="color:#f92672">||</span> currentPath.endsWith(<span style="color:#e6db74">&#34;.MP3&#34;</span>))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        currentIdx <span style="color:#f92672">=</span> idx;
</span></span><span style="display:flex;"><span>        currentType <span style="color:#f92672">=</span> TYPE_MP3;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (off <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">uint32_t</span> skipped <span style="color:#f92672">=</span> skipID3v2Tag(fileSrc);
</span></span><span style="display:flex;"><span>            LOG(<span style="color:#e6db74">&#34;Skipped %u bytes of ID3v2 tag</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, skipped);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            fileSrc<span style="color:#f92672">-&gt;</span>seek(off, SEEK_SET);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        mp3 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AudioGeneratorMP3();
</span></span><span style="display:flex;"><span>        mp3<span style="color:#f92672">-&gt;</span>begin(fileSrc, audioOut);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>Can you spot the difference?</p>
<h2 id="technical-comparison-object-vs-pointer-based-implementation">Technical Comparison: Object vs. Pointer-Based Implementation</h2>
<p>In the initial code, decoder objects like <code>mp3</code>, <code>wav</code>, and <code>flac</code> are used as stack-allocated objects (not pointers). Methods such as <code>mp3.isRunning()</code> and <code>mp3.stop()</code> are called directly on these objects, and there is no explicit memory management—objects are created and destroyed automatically as their scope changes.</p>
<p>In contrast, the improved code uses pointers for all decoder objects and the file source. For example, <code>mp3</code>, <code>wav</code>, <code>flac</code>, and <code>fileSrc</code> are all pointers. This approach allows for dynamic allocation (<code>new</code>) and explicit deallocation (<code>delete</code>) of resources. Before starting a new track, the code checks if a decoder exists and is running, stops it, deletes the object, and sets the pointer to <code>nullptr</code>. This ensures that resources are properly cleaned up and avoids memory leaks or dangling references.</p>
<h2 id="another-problem">Another problem</h2>
<p>was that some mp3s took an eternity to start playing. After a little testing and researching I found out, that this was probably due to the mp3 tags in the files.</p>
<p>I stumbled upon this nice little method to skip those tags in a very elegant and fast way:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">uint32_t</span> <span style="color:#a6e22e">skipID3v2Tag</span>(AudioFileSource <span style="color:#f92672">*</span>src)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> header[<span style="color:#ae81ff">10</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (src<span style="color:#f92672">-&gt;</span>read((<span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>)header, <span style="color:#ae81ff">10</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (memcmp(header, <span style="color:#e6db74">&#34;ID3&#34;</span>, <span style="color:#ae81ff">3</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        src<span style="color:#f92672">-&gt;</span>seek(<span style="color:#ae81ff">0</span>, SEEK_SET); <span style="color:#75715e">// not an ID3v2 tag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> tagSize <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        ((header[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7F</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">21</span>) <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        ((header[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7F</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">14</span>) <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        ((header[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7F</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">7</span>) <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        (header[<span style="color:#ae81ff">9</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7F</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> skipBytes <span style="color:#f92672">=</span> tagSize <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span>; <span style="color:#75715e">// +10 header
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    src<span style="color:#f92672">-&gt;</span>seek(skipBytes, SEEK_SET);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> skipBytes;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This works like a charm!
The tags are now skipped in a few ms instead of 30 seconds.</p>
<p>This was the final change that made the player what I intended it to be.</p>
<p>A digital music player that behaves like an old-school cassette player! Turn the switch on and music starts playing instantly! No boot time, no screen, no menus. Just music without distraction.</p>
<h1 id="finish-line">Finish line</h1>
<p>This change made all the difference. Finally, everything ran smoothly. There are still occasional crashes that I haven&rsquo;t fully tracked down yet, but they&rsquo;re mostly a thing of the past. Most of the time, the player now runs stably.</p>
<h1 id="a-nice-case">A nice case</h1>
<p>Of course, the player also needed a nice home. This time, I tried a new approach. I scanned the whole thing in 3D using the <a href="https://play.google.com/store/apps/details?id=com.epicgames.realityscan&amp;hl=en">RealityScan</a> app and then imported the model into <a href="https://www.blender.org/">Blender</a>.</p>
<p>I then quickly and roughly recreated the scan with simple objects like cubes and cylinders. I made sure to model all the openings to the outside in an &rsquo;exaggerated&rsquo; way so that I would end up with an actual opening.</p>
<p>After that, I surrounded the whole thing with a large cuboid and subtracted the inside from the outside.</p>
<p>The result was a quick and very precisely fitting case that fit perfectly after printing the first time :) Just the way I like it.</p>
<p>(think twice, print once!)</p>
<p><p class="md__image">
  <img class="img-fluid" src="3D-model.webp" alt="3D Scan"  />
</p></p>
<blockquote>
<p>the 3D scan of the combined modules</p></blockquote>
<p><p class="md__image">
  <img class="img-fluid" src="inner-construction.webp" alt="inner construction"  />
</p></p>
<blockquote>
<p>the remodeled scan</p></blockquote>
<p><p class="md__image">
  <img class="img-fluid" src="housing.webp" alt="the housing"  />
</p></p>
<blockquote>
<p>the finished housing</p></blockquote>
<h1 id="the-end">The End</h1>
<p>Sorry that I totally skipped the whole assembly and soldering part, the layout and PCB arrangement&hellip;</p>
<p>I didn&rsquo;t make any images during the whole process, but I think yours will look completely different anyway :)</p>
<p>Have fun!</p>

          </article>
        </div>
      </div>
      <div class="col-sm-12 col-md-12 col-lg-3">
        <div class="sticky-sidebar">
          
          <aside class="toc" id="toc">
              <h5>
                Table Of Contents
              </h5>
              <div class="toc-content">
                <nav id="TableOfContents">
  <ul>
    <li><a href="#espod---shuffle">ESPod - Shuffle</a></li>
    <li><a href="#yes-its-true">Yes it&rsquo;s true</a>
      <ul>
        <li><a href="#what-was-my-goal">What was my goal?</a></li>
      </ul>
    </li>
    <li><a href="#the-parts">The parts</a>
      <ul>
        <li><a href="#why">Why?</a></li>
      </ul>
    </li>
    <li><a href="#the-code">The code</a>
      <ul>
        <li><a href="#a-week-of-agony">A week of agony</a></li>
        <li><a href="#the-functions">The functions</a></li>
        <li><a href="#back-to-the-agony">Back to the agony</a></li>
        <li><a href="#technical-comparison-object-vs-pointer-based-implementation">Technical Comparison: Object vs. Pointer-Based Implementation</a></li>
        <li><a href="#another-problem">Another problem</a></li>
      </ul>
    </li>
    <li><a href="#finish-line">Finish line</a></li>
    <li><a href="#a-nice-case">A nice case</a></li>
    <li><a href="#the-end">The End</a></li>
  </ul>
</nav>
              </div>
          </aside>
          

          
          <aside class="tags">
            <h5>Tags</h5>
            <ul class="tags-ul list-unstyled list-inline">
              
              <li class="list-inline-item"><a href="https://philippraven.com/tags/music" target="_self">music</a></li>
              
              <li class="list-inline-item"><a href="https://philippraven.com/tags/mp3" target="_self">mp3</a></li>
              
              <li class="list-inline-item"><a href="https://philippraven.com/tags/flac" target="_self">flac</a></li>
              
              <li class="list-inline-item"><a href="https://philippraven.com/tags/wav" target="_self">wav</a></li>
              
              <li class="list-inline-item"><a href="https://philippraven.com/tags/player" target="_self">player</a></li>
              
              <li class="list-inline-item"><a href="https://philippraven.com/tags/esp32" target="_self">esp32</a></li>
              
              <li class="list-inline-item"><a href="https://philippraven.com/tags/programming" target="_self">programming</a></li>
              
              <li class="list-inline-item"><a href="https://philippraven.com/tags/audio" target="_self">audio</a></li>
              
            </ul>
          </aside>
          

          
          <aside class="social">
            <h5>Social</h5>
            <div class="social-content">
              <ul class="list-inline">
                <li class="list-inline-item text-center">
                  <a target="_blank" href="https://twitter.com/share?text=ESP32%20music%20player&url=https%3a%2f%2fphilippraven.com%2fblog%2fesp%2fesp32-music-player%2f">
                    <i class="fab fa-twitter"></i>
                  </a>
                </li>
                <li class="list-inline-item text-center">
                  <a target="_blank" href="https://api.whatsapp.com/send?text=ESP32%20music%20player: https%3a%2f%2fphilippraven.com%2fblog%2fesp%2fesp32-music-player%2f">
                    <i class="fab fa-whatsapp"></i>
                  </a>
                </li>
                <li class="list-inline-item text-center">
                  <a target="_blank" href="mailto:?subject=ESP32%20music%20player&amp;body=Check out this site https%3a%2f%2fphilippraven.com%2fblog%2fesp%2fesp32-music-player%2f">
                    <i class="fa fa-envelope"></i>
                  </a>
                </li> 
              </ul>
            </div>
          </aside>
          
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-12 col-md-12 col-lg-9 p-4">
        
      </div>
    </div>
  </div>
  <div class="p-2 px-3" id="rightSideButtonStack">
    <button class="p-2 px-3" onclick="topFunction()" id="topScroll">
      <i class="fas fa-angle-up"></i>
    </button>
    <button class="p-2 px-3" onclick="tocFunction()" id="tocScroll">
      <i class="fas fa-angle-double-down"></i>
    </button>
    <button class="p-2 px-3" onclick="bottomFunction()" id="bottomScroll">
      <i class="fas fa-angle-down"></i>
    </button>
  </div>
</section>

<script>
  var topScroll = document.getElementById('topScroll');
  window.onscroll = function() {scrollFunction()};

  function scrollFunction() {
    showTop();
    showToc();
    showBottom();
  }

  function showTop() {
    if(topScroll && topScroll != null && topScroll != 'undefined') {
      if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        topScroll.style.display = 'block';
      } else {
        topScroll.style.display = 'none';
      }
    }
  }

  function topFunction() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }

  
  var pageContent = document.getElementById('page-content');
  var bottomScroll = document.getElementById('bottomScroll');

  function showBottom() {
    if(bottomScroll && bottomScroll != null && bottomScroll != 'undefined' &&
       pageContent && pageContent != null && pageContent != 'undefined') {
      if(bottomInViewport(pageContent)) {
        bottomScroll.style.display = 'block';
      } else {
        bottomScroll.style.display = 'none';
      }
    }
  }

  function bottomFunction() {
    if(pageContent && pageContent != null && pageContent != 'undefined') {
      pageContent.scrollIntoView(false);
      bottomScroll.style.display = 'none';
    }
  }

  function bottomInViewport(element) {
    const rect = element.getBoundingClientRect();
    return (
      rect.bottom >= (window.innerHeight + 1|| document.documentElement.clientHeight + 1) 
    );
  }

  
  var tocScroll = document.getElementById('tocScroll');
  var toc = document.getElementById('toc');

  function showToc() {
    if(toc && toc != null && toc != 'undefined' &&
       tocScroll && tocScroll != null && tocScroll != 'undefined') {
      if(isInViewport(toc)) {
        tocScroll.style.display = 'none';
      } else {
        tocScroll.style.display = 'block';
      }
    }
  }

  function tocFunction() {
    if(toc && toc != null && toc != 'undefined') {
      toc.scrollIntoView(true);
    }
  }

  function isInViewport(element) {
    const rect = element.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
  }
</script>


  </div><footer>
    <div class="container py-3" id="recent-posts">
    
    <div class="h3 text-center text-secondary py-3">Recent blog posts</div>
    <div class="row justify-content-center">
        
        <div class="col-lg-4 col-md-6 pt-2">
            <div class="card h-100">
                <div class="card-body bg-transparent p-4 shadow-sm">
                    
                    
                    
                    
                    
                    

                    
                    
                        
                        
                            
                                
                                
                            
                        
                     
                    
                        <a href="/blog/esp/esp32-music-player-2/">
                            <img src="/blog/esp/esp32-music-player-2/iteration-2-1_hu_f4e24501842cd71.webp" alt="ESP32 music player 2" class="rounded img-fluid">
                        </a>
                    

                    <a href="/blog/esp/esp32-music-player-2/" class="primary-font card-title">
                        <h5 class="card-title bg-transparent" title="ESP32 music player 2">ESP32 music player 2</h5>
                    </a>
                </div>
                <div class="mt-auto card-footer">
                    <span class="float-start">May 31, 2025</span>
                    <a href="/blog/esp/esp32-music-player-2/" class="float-end btn btn-outline-info btn-sm">Read</a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6 pt-2">
            <div class="card h-100">
                <div class="card-body bg-transparent p-4 shadow-sm">
                    
                    
                    
                    
                    
                    

                    
                    
                        
                        
                            
                                
                                
                            
                        
                     
                    
                        <a href="/blog/esp/esp32-music-player/">
                            <img src="/blog/esp/esp32-music-player/3D-model_hu_942edbc969aff83d.webp" alt="ESP32 music player" class="rounded img-fluid">
                        </a>
                    

                    <a href="/blog/esp/esp32-music-player/" class="primary-font card-title">
                        <h5 class="card-title bg-transparent" title="ESP32 music player">ESP32 music player</h5>
                    </a>
                </div>
                <div class="mt-auto card-footer">
                    <span class="float-start">May 26, 2025</span>
                    <a href="/blog/esp/esp32-music-player/" class="float-end btn btn-outline-info btn-sm">Read</a>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6 pt-2">
            <div class="card h-100">
                <div class="card-body bg-transparent p-4 shadow-sm">
                    
                    
                    
                    
                    
                    

                    
                    
                        
                        
                            
                                
                                
                            
                        
                     
                    
                        <a href="/blog/projects/graffiti-bmw/">
                            <img src="/blog/projects/graffiti-bmw/feature_hu_45960779775a0ff0.webp" alt="Graffiti BMW" class="rounded img-fluid">
                        </a>
                    

                    <a href="/blog/projects/graffiti-bmw/" class="primary-font card-title">
                        <h5 class="card-title bg-transparent" title="Graffiti BMW">Graffiti BMW</h5>
                    </a>
                </div>
                <div class="mt-auto card-footer">
                    <span class="float-start">May 26, 2025</span>
                    <a href="/blog/projects/graffiti-bmw/" class="float-end btn btn-outline-info btn-sm">Read</a>
                </div>
            </div>
        </div>
        
    </div>
    
</div>
<div class="text-center pt-2">
    

    

    

    

    
</div><div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-4 text-center">
            <div class="pb-2">
                <a href="https://philippraven.com/" title="philippraven">
                    <img alt="Footer logo" src="/icon.png"
                        height="40px" width="40px">
                </a>
            </div>
            &copy; 2026  All Rights Reserved
            <br>
            <a href="https://philippraven.com/blog/index.xml" type="application/rss+xml">RSS Feed</a>
            
            
                
                
                    
                
                
                
                    
                    
                
            
        </div>
    </div>
</div><div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-4 text-center">
            <a href="https://philippraven.com//legal-notice" title="Legal Notice">Legal Notice</a>
        </div>
    </div>
</div></footer><script src="/bootstrap-5/js/bootstrap.bundle.min.js"></script>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

</script>









  <section id="search-content" class="py-2">
    <div class="container" id="search-results"></div>
  </section>
</body>

</html>